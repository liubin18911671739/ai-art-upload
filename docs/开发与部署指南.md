# 开发与部署指南

本文档覆盖本项目从本地开发到生产部署的完整步骤。

## 1. 架构说明

- 前端与 API：Next.js（App Router）
- 数据库：Supabase Postgres
- 文件存储：Supabase Storage（Public Bucket）
- AI 任务：RunPod Serverless（`/run` + async webhook）
- Shopify：当前默认关闭（`SHOPIFY_ENABLED=false`）

## 2. 本地开发

### 2.1 前置环境

1. 安装 Node.js 20+
2. 安装 pnpm 10+
3. 准备 Supabase 项目（数据库 + Storage Bucket）
4. 准备 RunPod Serverless Endpoint

### 2.2 安装依赖

```bash
pnpm install
```

### 2.3 配置环境变量

1. 复制模板：

```bash
cp .env.local.example .env.local
```

2. 重点填写以下变量：

- `SUPABASE_DB_URL`
- `SUPABASE_URL`
- `SUPABASE_SERVICE_ROLE_KEY`（必须是 `service_role`，不能用 `anon`）
- `SUPABASE_STORAGE_BUCKET`
- `SUPABASE_STORAGE_PUBLIC_DOMAIN`（可选，默认可自动推导）
- `RUNPOD_API_KEY`
- `RUNPOD_ENDPOINT_ID`
- `RUNPOD_WEBHOOK_SECRET`
- `NEXT_PUBLIC_BASE_URL`
- `ALLOW_SELF_SIGNED_TLS`（可选，仅本地调试有自签名/代理证书时使用）

3. 生成 `RUNPOD_WEBHOOK_SECRET` 示例：

```bash
openssl rand -hex 32
```

4. 非 mock 模式下，`NEXT_PUBLIC_BASE_URL` 必须是公网可访问域名，不能是 `localhost`。

### 2.4 初始化数据库（Supabase SQL Editor）

在 Supabase 控制台 SQL Editor 执行：

```sql
DO $$
BEGIN
  CREATE TYPE order_status AS ENUM ('PENDING', 'PROCESSING', 'SUCCEEDED', 'FAILED');
EXCEPTION
  WHEN duplicate_object THEN NULL;
END $$;

CREATE TABLE IF NOT EXISTS webhook_events (
  event_id TEXT PRIMARY KEY,
  topic TEXT NOT NULL,
  processed_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS orders (
  id TEXT PRIMARY KEY,
  shopify_order_id TEXT UNIQUE NOT NULL,
  image_url TEXT NOT NULL,
  style TEXT NOT NULL,
  status order_status NOT NULL DEFAULT 'PENDING',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT orders_id_format_chk
    CHECK (id ~ '^ORD-[0-9]{8}-[A-Z0-9]{4}$')
);

CREATE TABLE IF NOT EXISTS jobs (
  runpod_id TEXT PRIMARY KEY,
  order_id TEXT NOT NULL REFERENCES orders(id) ON DELETE CASCADE,
  output_image_url TEXT,
  output_video_url TEXT
);

CREATE INDEX IF NOT EXISTS jobs_order_id_idx ON jobs(order_id);
```

### 2.5 配置 Supabase Storage

1. 创建 Bucket（名称与 `SUPABASE_STORAGE_BUCKET` 一致）
2. 建议设置为 Public（便于 RunPod 读取输入图）
3. 确认上传后对象可通过 Public URL 访问

### 2.6 启动开发服务

```bash
pnpm dev
```

打开 `http://localhost:3000`。

### 2.7 本地验收

1. 上传 `jpeg/png/webp` 且小于 10MB 的图片
2. 选择风格并提交任务
3. 在页面看到 `RunPod Job ID` 和状态轮询
4. 任务完成后可查看生成结果链接

## 3. 生产部署

### 3.1 部署前检查

1. `POC_MOCK_MODE=false`
2. `NEXT_PUBLIC_BASE_URL` 已设置为最终线上域名（例如 `https://app.example.com`）
3. Supabase 生产库已完成建表
4. Storage Bucket 与公网访问正常
5. RunPod Endpoint 可用且 workflow 正常

### 3.2 环境变量（生产）

将 `.env.local.example` 中的变量全部配置到部署平台，至少包含：

- `POC_MOCK_MODE=false`
- `SUPABASE_DB_URL`
- `SUPABASE_URL`
- `SUPABASE_SERVICE_ROLE_KEY`
- `SUPABASE_STORAGE_BUCKET`
- `RUNPOD_API_KEY`
- `RUNPOD_ENDPOINT_ID`
- `RUNPOD_WEBHOOK_SECRET`
- `RUNPOD_WEBHOOK_TOKEN_PARAM=token`
- `NEXT_PUBLIC_BASE_URL`
- `SHOPIFY_ENABLED=false`（当前建议）
- `ALLOW_SELF_SIGNED_TLS=false`（生产务必保持关闭）

### 3.3 触发部署

常见方式：

1. Git 推送触发平台自动构建
2. 平台执行 `pnpm install`、`pnpm build`、`pnpm start`

### 3.4 RunPod 回调链路确认

项目会自动拼接 webhook URL：

`{NEXT_PUBLIC_BASE_URL}/api/webhooks/runpod?{RUNPOD_WEBHOOK_TOKEN_PARAM}={RUNPOD_WEBHOOK_SECRET}`

上线后请检查：

1. RunPod 任务能成功提交
2. RunPod 可回调到你的线上 `/api/webhooks/runpod`
3. 数据库 `orders/jobs` 状态会从 `PROCESSING` 更新为 `SUCCEEDED/FAILED`

## 4. 可选：开启 Shopify

当前默认关闭（`SHOPIFY_ENABLED=false`）。如需开启：

1. 设置 `SHOPIFY_ENABLED=true`
2. 填写 `SHOPIFY_WEBHOOK_SECRET`
3. 填写 `SHOPIFY_STORE_DOMAIN`
4. 填写 `SHOPIFY_ADMIN_ACCESS_TOKEN`
5. 配置 `SHOPIFY_API_VERSION`（默认 `2025-10`）

## 5. 常见问题

### 5.1 提交 RunPod 失败：`NEXT_PUBLIC_BASE_URL must be a production domain`

原因：非 mock 模式下不允许 `localhost` 作为 webhook 基地址。  
处理：把 `NEXT_PUBLIC_BASE_URL` 改为公网域名。

### 5.2 `imageUrl must match storage public domain`

原因：`/api/transform` 会校验图片 URL 域名与 `SUPABASE_STORAGE_PUBLIC_DOMAIN`（或推导域名）一致。  
处理：检查上传返回的 `publicUrl` 与 env 配置是否一致。

### 5.3 RunPod 请求体超限

原因：`input.images` base64 会放大体积，超过 `/run` 限制。  
处理方案：

1. 压缩输入图片
2. 将 `RUNPOD_IMAGE_TRANSPORT=url` 改为 URL 传图
3. 视需要调整 `RUNPOD_RUN_MAX_REQUEST_BYTES`（默认 10MB）

### 5.4 数据库连接报错：`getaddrinfo ENOTFOUND db.<project-ref>.supabase.co`

原因：`SUPABASE_DB_URL` 使用的数据库主机不可解析（项目引用错误、DNS 问题，或当前环境不支持该主机）。

处理方案：

1. 打开 Supabase Dashboard -> Project Settings -> Database -> Connection string
2. 复制最新连接串，优先使用 **Transaction Pooler**
3. 更新 `SUPABASE_DB_URL` 后重启服务

提示：Pooler 连接串通常形如  
`postgresql://postgres.<project-ref>:<password>@aws-0-<region>.pooler.supabase.com:6543/postgres?sslmode=verify-full`

### 5.5 提交任务报错：`self-signed certificate in certificate chain`

原因：运行环境存在 TLS 拦截代理或自签名证书，Node.js 无法验证外部 HTTPS 证书链。

处理方案（推荐）：

1. 将代理/根证书写入本机文件（例如 `corp-ca.pem`）
2. 通过 `NODE_EXTRA_CA_CERTS=/path/to/corp-ca.pem` 启动服务

临时方案（仅本地调试）：

1. 在 `.env.local` 设置 `ALLOW_SELF_SIGNED_TLS=true`
2. 重启服务
3. 调试完成后恢复为 `false`

### 5.6 任务状态为 `FAILED` 且包含 `ckpt_name ... not in [...]`

原因：`RUNPOD_CHECKPOINT_NAME`（或风格覆盖变量）与当前 RunPod Endpoint 的可用 checkpoint 不一致。

处理方案：

1. 打开 RunPod 控制台，查看该 Endpoint 当前可用 checkpoint 列表
2. 将 `.env.local` 的 `RUNPOD_CHECKPOINT_NAME` 改为列表中存在的模型名
示例：若列表只有 `flux1-dev-fp8.safetensors`，则应设置为该值。
3. 若需分风格模型，分别设置 `RUNPOD_CHECKPOINT_SKETCH` / `RUNPOD_CHECKPOINT_WATERCOLOR` / `RUNPOD_CHECKPOINT_OIL`
4. 重启服务后重新提交任务
